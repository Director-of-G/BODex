# cuDex
*Scalable Dexterous Grasp Synthesis Pipeline developed on cuRobo*

<!--
Copyright (c) 2023 NVIDIA CORPORATION & AFFILIATES. All rights reserved.

NVIDIA CORPORATION, its affiliates and licensors retain all intellectual
property and proprietary rights in and to this material, related
documentation and any modifications thereto. Any use, reproduction,
disclosure or distribution of this material and related documentation
without an express license agreement from NVIDIA CORPORATION or
its affiliates is strictly prohibited.
-->


1. Installation.
```
conda create -n cudex python=3.10
conda install pytorch==2.0.1 torchvision==0.15.2 pytorch-cuda=11.7 -c pytorch -c nvidia   # pytorch
pip install usd-core # for visualization
pip install -e . --no-build-isolation  # install this repo

pip install torch-scatter
conda install pinocchio -c conda-forge
cd src/curobo/geom/cpp
python setup.py install    # install hppfcl_openmp_wrapper
```


2. Create two soft links to the output folder and the object dataset. 
   ```
   cd cuDex
   ln -s {$OUTPUT_FOLDER} src/curobo/content/assets/output     # output path
   ln -s {$YOUR_DATA_FOLDER} src/curobo/content/assets/object  # object path
   ```
   The default data organization is shown below. If using a different organization, change "dir" and "suffix" in `src/curobo/content/configs/manip/xxx.yml`.
   ```
   src/curobo/content/assets/object
   |- meshdata
   |  |- object1/coacd
   |  |  |- decomposed.obj
   |  |  |- simply.obj      # Results from the next step without internal faces.
   |  |  |_ ...
   |  |- object2/coacd
   |  |_ ...
   |_ ...
   
   ```


3. [Choice] If the object mesh has internal faces (e.g. dirty mesh or generated by CoaCD), we need to remove those internal faces.
   ```
   # Change the "obj_folder" and "manifoldplus_path" in scripts/simplification.py
   blender -b -P scripts/simplification.py
   ```

4. Run the following cmd to optimize a grasp. The comments for manip configs can be found in `scr/curobo/content/configs/manip/template.yml` and `scr/curobo/content/configs/manip/README.md`.
   ```
   cd examples
   CUDA_VISIBLE_DEVICES=7 python example_grasp/plan_batch_env.py -c sim_shadow/fc.yml -w 40 -p world 
   CUDA_VISIBLE_DEVICES=7 python example_grasp/plan_mogen_batch.py -c sim_shadow/tabletop.yml
   
   # multi-gpu
   python scripts/multi_gpu.py -c sim_shadow/tabletop.yml -m grasp -g 0 1 2 3 4 5 6 7 
   python scripts/multi_gpu.py -c sim_shadow/tabletop.yml -m mogen -g 0 1 2 3 4 5 6 7
   python scripts/multi_gpu.py -c sim_shadow/tabletop.yml -m grasp_and_mogen -g 0 1 2 3 4 5 6 7
   ```

5. Install [OpenUSD](https://github.com/PixarAnimationStudios/OpenUSD) on your local computer. Download saved usda file to your local computer and you can visualize it.
   ```
   usdview {$FILE_NAME}.usda
   ```


6. [Not Recommanded] To use different qpsolver ([proxqp](https://github.com/Simple-Robotics/proxsuite), [osqp](https://github.com/osqp/osqp)), you need to install other dependence.

```
########## ProxQP ###############
git clone git@github.com:Simple-Robotics/proxsuite.git
conda install simde -c conda-forge
conda install llvm-openmp -c conda-forge
conda install cmake -c conda-forge  # cmake should > 3.25!

export PATH=$CONDA_PREFIX/include:$PATH

mkdir build && cd build

cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTING=OFF -DBUILD_PYTHON_INTERFACE=ON -DBUILD_WITH_OPENMP_SUPPORT=ON -DCMAKE_INSTALL_PREFIX=$CONDA_PREFIX

make
make install

########## OSQP ###############
pip install cvxpy
# Add 'return solution' to Line 1414 in {$CONDA_PREFIX}/lib/python3.10/site-packages/cvxpy/problems/problem.py 

```

### Difference with Official Repository
0. This repository supports floating base for FK and optimizer(currently only for _greedy_line_search).

1. By default, the official repository will construct the robot to cover all links in `collision_link_names`, `ee_link`, `link_names` and `extra_links`. However, we only cover the `ee_link`, `link_names` and `extra_links`. 

- This feature helps us to flexibly change valid kinematic chains by identifying link_names.

- One side effect is that one needs to add all needed end-effectors to `link_names` in `src/curobo/content/robot/{$ROBOT_NAME}.yml`.

<!-- 
### Known Issues
Q. "#error The version of CUB in your include path is not compatible with this release of Thrust..."

A. add `#define THRUST_IGNORE_CUB_VERSION_CHECK true` before `#ifndef THRUST_IGNORE_CUB_VERSION_CHECK` in `/usr/local/{$YOURCUDA}/include/thrust/system/cuda/config.h` -->



## Citation

If you found this repository useful, please consider to cite the following works,

```
@misc{curobo_report23,
      title={cuRobo: Parallelized Collision-Free Minimum-Jerk Robot Motion Generation},
      author={Balakumar Sundaralingam and Siva Kumar Sastry Hari and Adam Fishman and Caelan Garrett
              and Karl Van Wyk and Valts Blukis and Alexander Millane and Helen Oleynikova and Ankur Handa
              and Fabio Ramos and Nathan Ratliff and Dieter Fox},
      year={2023},
      eprint={2310.17274},
      archivePrefix={arXiv},
      primaryClass={cs.RO}
}
```
